<div class="container my-5">
  <ng-container *ngIf="product; else notFound">
    <div class="row g-4 align-items-start">
      <!-- üñºÔ∏è Imagen / thumbnail -->
      <div class="col-12 col-md-6">
        <div class="surface p-3 p-sm-4 h-100 d-flex align-items-center justify-content-center">
          <div class="product-hero">
            <img
              [src]="heroUrl"
              [alt]="product.name"
              loading="lazy"
              class="img-fluid rounded"
            />
          </div>
        </div>
      </div>

      <!-- üßæ Informaci√≥n del producto -->
      <div class="col-12 col-md-6">
        <div class="surface p-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="m-0">{{ product.name }}</h2>
            <span
              class="badge"
              [ngClass]="product.stock > 0 ? 'text-bg-success' : 'text-bg-danger'"
            >
              {{ product.stock > 0 ? 'En stock' : 'Agotado' }}
            </span>
          </div>

          <p class="text-muted mb-3">{{ product.description }}</p>

          <!-- üí∞ Precio y stock -->
          <div
            class="d-flex align-items-center justify-content-between py-3 border-top border-bottom mb-3"
          >
            <div>
              <div class="text-muted small">Precio</div>
              <div class="price fs-3 m-0">
                {{ product.price | currency:'GTQ':'symbol-narrow':'1.2-2' }}
              </div>
            </div>
            <div class="text-end">
              <div class="text-muted small">Stock</div>
              <div class="fw-semibold">{{ product.stock }}</div>
            </div>
          </div>

          <!-- üõí Botones de acci√≥n -->
          <div class="d-grid gap-2">
            <button
              class="btn btn-primary btn-lg"
              (click)="addToCart()"
              [disabled]="product.stock <= 0"
            >
              <i class="bi bi-bag-plus me-2"></i>
              {{ product.stock > 0 ? 'Agregar al carrito' : 'Sin stock' }}
            </button>

            <a routerLink="/" class="btn btn-outline-light">
              <i class="bi bi-arrow-left me-2"></i> Regresar al inicio
            </a>
          </div>

          <!-- üîí Beneficios -->
          <ul class="list-unstyled d-flex gap-4 mt-4 text-muted small">
            <li class="d-flex align-items-center gap-2">
              <i class="bi bi-shield-check"></i> Pago seguro
            </li>
            <li class="d-flex align-items-center gap-2">
              <i class="bi bi-truck"></i> Env√≠os a todo el pa√≠s
            </li>
            <li class="d-flex align-items-center gap-2">
              <i class="bi bi-arrow-repeat"></i> Devoluci√≥n 7 d√≠as
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- üí¨ Secci√≥n de Rese√±as -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="surface p-4 rounded-3 shadow-sm">
          <h4 class="mb-3">
            <i class="bi bi-chat-heart"></i> Rese√±as de este producto
          </h4>

          <!-- üß≠ Listado de rese√±as -->
          <div *ngIf="reviews.length > 0; else noReviews">
            <div
              *ngFor="let r of reviews"
              class="border-bottom py-2 d-flex justify-content-between"
            >
              <div>
                <strong>{{ r.user?.name }}</strong>
                <div class="text-warning small">
                  <i *ngFor="let n of [].constructor(r.rating)" class="bi bi-star-fill"></i>
                  <i *ngFor="let n of [].constructor(5 - r.rating)" class="bi bi-star"></i>
                </div>
                <p class="mb-1">{{ r.comment }}</p>
              </div>
              <div class="text-muted small text-end">
                {{ r.createdAt | date:'shortDate' }}
              </div>
            </div>
          </div>

          <ng-template #noReviews>
            <div class="text-muted text-center py-3">
              <i class="bi bi-chat-left-dots"></i>
              <p class="mt-2 mb-0">A√∫n no hay rese√±as para este producto.</p>
            </div>
          </ng-template>

          <!-- ‚úçÔ∏è Formulario de nueva rese√±a -->
          <div class="mt-4">
            <h6>Deja tu rese√±a</h6>
            <form (ngSubmit)="submitReview(f)" #f="ngForm">
              <div class="row g-3 align-items-center">
                <div class="col-md-2">
                  <label class="form-label mb-1 small">Calificaci√≥n</label>
                  <select
                    class="form-select"
                    [(ngModel)]="newReview.rating"
                    name="rating"
                    required
                  >
                    <option *ngFor="let n of [1,2,3,4,5]" [value]="n">{{ n }}</option>
                  </select>
                </div>

                <div class="col-md-8">
                  <label class="form-label mb-1 small">Comentario</label>
                  <textarea
                    class="form-control"
                    rows="1"
                    placeholder="Escribe tu opini√≥n..."
                    [(ngModel)]="newReview.comment"
                    name="comment"
                    required
                  ></textarea>
                </div>

                <div class="col-md-2 text-end">
                  <button
                    type="submit"
                    class="btn btn-primary w-100"
                    [disabled]="f.invalid || submitting"
                  >
                    <i class="bi bi-send"></i>
                    Enviar
                  </button>
                </div>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>
  </ng-container>

  <!-- ‚ùå Producto no encontrado -->
  <ng-template #notFound>
    <div class="surface p-5 text-center">
      <div class="display-6 mb-3">üß≠</div>
      <h4 class="mb-2">Producto no encontrado</h4>
      <p class="text-muted mb-4">
        Es posible que la URL haya cambiado o el producto ya no exista.
      </p>
      <a routerLink="/" class="btn btn-primary">Volver al cat√°logo</a>
    </div>
  </ng-template>
</div>
